//----------------------------------------------------
//  ⭐ 客户预览：直接在新标签页打开，不下载文件
//----------------------------------------------------
function exportHTML(rec){
  const r = {...rec, photos: normalizePhotos(rec.photos)};
  const escHtml = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;");

  const picSection = (title, arr)=> arr.length ? `
    <h3>${title}</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px;">
      ${arr.map(p=>`
        <div style="flex:1 1 260px;max-width:330px;">
          <img src="${p.dataURL}" style="width:100%;border-radius:10px;border:1px solid #ddd;">
        </div>`).join("")}
    </div>
  `:"";

  const html = `
<!DOCTYPE html><html><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escHtml(r.name)} 档案预览</title>
<style>
body{font:14px/1.6 -apple-system,Segoe UI,Roboto;padding:16px;background:#f3f4f6;}
.card{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;border:1px solid #e5e7eb;}
.row{display:flex;gap:10px;margin:6px 0;}
.key{width:90px;color:#555;font-weight:600;}
.pill{background:#f3f4f6;border-radius:999px;padding:4px 8px;margin-right:4px;font-size:12px;}
</style>
</head><body>
<div class="card">
<h2>${escHtml(r.name)} 档案</h2>

<div class="row"><div class="key">年龄</div><div>${r.age||""} 岁</div></div>
<div class="row"><div class="key">籍贯</div><div>${escHtml(r.origin)}</div></div>
<div class="row"><div class="key">属相</div><div>${escHtml(r.zodiac)}</div></div>
<div class="row"><div class="key">身高</div><div>${r.height||""} cm</div></div>
<div class="row"><div class="key">体重</div><div>${r.weight||""} kg</div></div>
<div class="row"><div class="key">学历</div><div>${escHtml(r.education)}</div></div>
<div class="row"><div class="key">住家</div><div>${escHtml(r.livein)}</div></div>
<div class="row"><div class="key">电话</div><div>${escHtml(r.phone)}</div></div>

<div class="row"><div class="key">城市</div>
  <div>${(r.cities||[]).map(c=>`<span class="pill">${escHtml(c)}</span>`).join("")}</div>
</div>

<div class="row"><div class="key">技能</div>
  <div>${(r.skills||[]).map(s=>`<span class="pill">${escHtml(s)}</span>`).join("")}</div>
</div>

<div class="row"><div class="key">薪资</div><div>${escHtml(r.salary)}</div></div>

${r.notes? `<h3>备注</h3><div>${escHtml(r.notes)}</div>`:""}

${picSection("生活照 / 证件照", r.photos.life)}
${picSection("菜品展示", r.photos.dishes)}
${picSection("技能证书", r.photos.certs)}
${picSection("体检证明", r.photos.medical)}

</div></body></html>`;

  // ⭐ 不下载 → 直接打开新标签页
  const win = window.open("", "_blank");
  win.document.open();
  win.document.write(html);
  win.document.close();
}
//----------------------------------------------------
//         自动解析原始资料（微信复制的文本）
//----------------------------------------------------
function parseRaw(){
  const t = $("raw").value.trim();
  if(!t){ alert("请先粘贴原始资料"); return; }

  const get=(keys)=>{
    for(const k of keys){
      const m=t.match(new RegExp(k+"[：: ]*([^\\n，,。；;]+)"));
      if(m) return m[1].trim();
    }
    return "";
  };

  $("name").value = get(["姓名","阿姨","名字"]);
  $("age").value = get(["年龄","岁数"]).replace(/\D/g,"");
  $("origin").value = get(["籍贯","老家","来自"]);
  $("zodiac").value = get(["属相","生肖"]);
  $("height").value = get(["身高"]).replace(/\D/g,"");
  $("weight").value = get(["体重"]).replace(/\D/g,"");
  $("education").value = get(["学历","文化"]);
  $("phone").value = get(["电话","微信","联系方式"]);
  $("exp").value = get(["从业年限","经验"]).replace(/\D/g,"");
  $("salary").value = get(["薪资","工资"]);
  $("livein").value = /不住家|否/.test(get(["住家"])) ? "否" : "是";
  $("cities").value = get(["城市","区域","可服务"]);
  $("skills").value = get(["技能","特长","擅长"]);
  $("notes").value = get(["备注","说明","其他"]);
}

//----------------------------------------------------
//                  保存与编辑
//----------------------------------------------------
let EDIT_ID = null;

async function collectRecord(){
  async function collectFiles(input){
    const arr=[];
    for(const f of Array.from(input.files||[])){
      arr.push({
        name:f.name,
        type:f.type,
        size:f.size,
        dataURL: await fileToDataURL(f)
      });
    }
    return arr;
  }

  return {
    id: EDIT_ID || uuid(),
    name: $("name").value.trim(),
    age: Number($("age").value)||"",
    origin: $("origin").value.trim(),

    zodiac: $("zodiac").value.trim(),
    height: Number($("height").value)||"",
    weight: Number($("weight").value)||"",
    education: $("education").value.trim(),

    phone: $("phone").value.trim(),
    exp: Number($("exp").value)||"",
    livein: $("livein").value,
    salary: $("salary").value.trim(),
    cities: normList($("cities").value),
    skills: normList($("skills").value),
    notes: $("notes").value.trim(),

    photos:{
      life:   await collectFiles($("photos_life")),
      dishes: await collectFiles($("photos_dishes")),
      certs:  await collectFiles($("photos_certs")),
      medical:await collectFiles($("photos_medical")),
    },

    updatedAt: Date.now()
  };
}

async function saveRecord(){
  const r = await collectRecord();
  if(!r.name){ alert("请填写姓名"); return; }
  await dbPut(r);
  EDIT_ID=null;
  resetForm();
  loadList();
}

function resetForm(){
  EDIT_ID=null;
  ["raw","name","age","origin","zodiac","height","weight","education",
   "phone","exp","salary","cities","skills","notes"]
  .forEach(id=>$(id).value="");

  $("livein").value="";
  $("photos_life").value="";
  $("photos_dishes").value="";
  $("photos_certs").value="";
  $("photos_medical").value="";
}

//----------------------------------------------------
//                     筛选
//----------------------------------------------------
function filterData(list){
  const q = $("q").value.trim().toLowerCase();
  const live = $("fq_livein").value;
  const city = $("fq_city").value.trim();
  const amin = Number($("fq_age_min").value)||null;
  const amax = Number($("fq_age_max").value)||null;
  const skill = $("fq_skill").value.trim().toLowerCase();

  return list.filter(r=>{
    if(live && r.livein!==live) return false;
    if(amin!=null && r.age!=="" && r.age<amin) return false;
    if(amax!=null && r.age!=="" && r.age>amax) return false;
    if(city && !(r.cities||[]).some(c=>c.includes(city))) return false;
    if(skill && !(r.skills||[]).some(s=>s.toLowerCase().includes(skill))) return false;

    if(q){
      const blob=[
        r.name,r.origin,r.zodiac,r.education,r.phone,r.salary,
        r.notes,(r.skills||[]).join(","),(r.cities||[]).join(",")
      ].join(" ").toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
}

//----------------------------------------------------
//                    列表渲染
//----------------------------------------------------
let CACHE=[];

async function loadList(){
  CACHE = await dbAll();
  CACHE.sort((a,b)=>b.updatedAt - a.updatedAt);

  const data = filterData(CACHE);
  $("countInfo").textContent = `共 ${data.length} 条`;
  const list=$("list");
  list.innerHTML="";

  if(!data.length){
    $("empty").style.display="block";
    return;
  }
  $("empty").style.display="none";

  data.forEach(r=>{
    const wrap=document.createElement("div");
    wrap.className="item";

    wrap.innerHTML = `
      <div class="right">
        <button class="btn btn-line" data-act="preview">预览</button>
        <button class="btn btn-accent" data-act="png">长图</button>
        <button class="btn btn-danger" data-act="del">删</button>
      </div>
      <h3>${esc(r.name)}</h3>
      <div class="meta">${r.age? r.age+"岁 · ":""}${esc(r.origin)}</div>
      <div class="meta">属相：${esc(r.zodiac||"")}</div>
      <div class="meta">身高：${r.height||""} cm　体重：${r.weight||""} kg</div>
      <div class="meta">学历：${esc(r.education||"")}</div>
      <div class="meta">住家：${esc(r.livein||"")}</div>
      <div class="meta">城市：${(r.cities||[]).join("，")}</div>
      <div class="meta">技能：${(r.skills||[]).join("，")}</div>
    `;

    wrap.querySelector('[data-act="preview"]').onclick = ()=> exportHTML(r);
    wrap.querySelector('[data-act="png"]').onclick = ()=> exportPNG(r);
    wrap.querySelector('[data-act="del"]').onclick = async()=>{
      if(confirm("确定删除？")){
        await dbDel(r.id);
        loadList();
      }
    };

    wrap.ondblclick = ()=> editRecord(r.id);
    list.appendChild(wrap);
  });
}

function editRecord(id){
  const r = CACHE.find(x=>x.id===id);
  if(!r) return;
  EDIT_ID=r.id;

  $("name").value=r.name||"";
  $("age").value=r.age||"";
  $("origin").value=r.origin||"";
  $("zodiac").value=r.zodiac||"";
  $("height").value=r.height||"";
  $("weight").value=r.weight||"";
  $("education").value=r.education||"";
  $("phone").value=r.phone||"";
  $("exp").value=r.exp||"";
  $("salary").value=r.salary||"";
  $("cities").value=(r.cities||[]).join(",");
  $("skills").value=(r.skills||[]).join(",");
  $("notes").value=r.notes||"";
  $("livein").value=r.livein||"";

  window.scrollTo({top:0,behavior:"smooth"});
}

//----------------------------------------------------
// ⭐ 预览：直接打开新标签页（不下载）
//----------------------------------------------------
function normalizePhotos(p){
  return {
    life:p.life||[], dishes:p.dishes||[],
    certs:p.certs||[], medical:p.medical||[]
  };
}

function exportHTML(rec){
  const r={...rec,photos:normalizePhotos(rec.photos)};
  const escHtml = s=>String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;");

  const pic = (title, arr)=> arr.length?`
    <h3>${title}</h3>
    <div style="display:flex;flex-wrap:wrap;gap:12px;">
      ${arr.map(p=>`
        <div style="flex:1 1 260px;max-width:330px;">
          <img src="${p.dataURL}" style="width:100%;border-radius:10px;border:1px solid #ddd;">
        </div>
      `).join("")}
    </div>
  `:"";

  const html = `
<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escHtml(r.name)} 档案预览</title>
<style>
body{font:14px/1.6 -apple-system,Segoe UI,Roboto;padding:20px;background:#f3f4f6;}
.card{max-width:900px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;border:1px solid #e5e7eb;}
.row{display:flex;gap:10px;margin:6px 0;}
.key{width:90px;color:#555;font-weight:600;}
.pill{background:#f3f4f6;border-radius:999px;padding:4px 8px;margin-right:4px;font-size:12px;}
</style>
</head><body>
<div class="card">
<h2>${escHtml(r.name)} 档案</h2>

<div class="row"><div class="key">年龄</div><div>${r.age||""} 岁</div></div>
<div class="row"><div class="key">籍贯</div><div>${escHtml(r.origin)}</div></div>
<div class="row"><div class="key">属相</div><div>${escHtml(r.zodiac)}</div></div>
<div class="row"><div class="key">身高</div><div>${r.height||""} cm</div></div>
<div class="row"><div class="key">体重</div><div>${r.weight||""} kg</div></div>
<div class="row"><div class="key">学历</div><div>${escHtml(r.education)}</div></div>
<div class="row"><div class="key">住家</div><div>${escHtml(r.livein)}</div></div>
<div class="row"><div class="key">电话</div><div>${escHtml(r.phone)}</div></div>

<div class="row"><div class="key">城市</div>
  <div>${(r.cities||[]).map(c=>`<span class="pill">${escHtml(c)}</span>`).join("")}</div>
</div>

<div class="row"><div class="key">技能</div>
  <div>${(r.skills||[]).map(s=>`<span class="pill">${escHtml(s)}</span>`).join("")}</div>
</div>

<div class="row"><div class="key">薪资</div><div>${escHtml(r.salary)}</div></div>

${r.notes? `<h3>备注</h3><div>${escHtml(r.notes)}</div>`:""}

${pic("生活照 / 证件照", r.photos.life)}
${pic("菜品展示", r.photos.dishes)}
${pic("技能证书", r.photos.certs)}
${pic("体检证明", r.photos.medical)}

</div></body></html>`;

  const win = window.open("", "_blank");
  win.document.open();
  win.document.write(html);
  win.document.close();
}

//----------------------------------------------------
//  ⭐ 稳定版高清长图导出（scale=1.5，防闪退）
//----------------------------------------------------
function buildLongImageHTML(r){
  const p = normalizePhotos(r.photos);
  const sec=(title,arr)=>arr.length?`
    <h2 style="margin:20px 0 10px;">${title}</h2>
    ${arr.map(p=>`
      <img src="${p.dataURL}"
           style="width:100%;border-radius:12px;margin:12px 0;border:1px solid #ddd;">
    `).join("")}
  `:"";

  return `
<h1>${esc(r.name)} 档案</h1>
<p>年龄：${r.age||""} 岁</p>
<p>籍贯：${esc(r.origin)}</p>
<p>属相：${esc(r.zodiac)}</p>
<p>身高：${r.height||""} cm</p>
<p>体重：${r.weight||""} kg</p>
<p>学历：${esc(r.education)}</p>
<p>住家：${esc(r.livein)}</p>
<p>电话：${esc(r.phone)}</p>
<p>城市：${(r.cities||[]).join("，")}</p>
<p>技能：${(r.skills||[]).join("，")}</p>
<p>薪资：${esc(r.salary)}</p>

${r.notes? `<h2>备注</h2><p>${esc(r.notes)}</p>`:""}

${sec("生活照 / 证件照", p.life)}
${sec("菜品展示", p.dishes)}
${sec("技能证书", p.certs)}
${sec("体检证明", p.medical)}
`;
}

async function exportPNG(rec){
  const box=document.createElement("div");
  box.style.position="fixed";
  box.style.left="-20000px";
  box.style.top="0";
  box.style.width="760px";    // 更安全的宽度（防闪退）
  box.style.padding="20px";
  box.style.background="#fff";
  box.innerHTML=buildLongImageHTML(rec);
  document.body.appendChild(box);

  const canvas = await html2canvas(box,{
    scale:1.5,       // 清晰但不会爆内存
    useCORS:true,
    allowTaint:true
  });

  const url=canvas.toDataURL("image/png");
  const a=document.createElement("a");
  a.href=url;
  a.download=`${rec.name}_档案长图.png`;
  a.click();

  box.remove();
}

//----------------------------------------------------
//                 事件绑定
//----------------------------------------------------
$("btnParse").onclick=parseRaw;
$("btnClearRaw").onclick=()=>$("raw").value="";
$("btnSave").onclick=saveRecord;
$("btnReset").onclick=resetForm;
$("btnClearFilter").onclick=()=>{
  ["q","fq_city","fq_age_min","fq_age_max","fq_skill"].forEach(id=>$(id).value="");
  $("fq_livein").value="";
  loadList();
};
$("btnWipe").onclick=async()=>{
  if(confirm("确定删除全部？")){
    await dbClear();
    loadList();
  }
};

document.querySelectorAll("#q,#fq_city,#fq_age_min,#fq_age_max,#fq_skill")
  .forEach(el=> el.oninput=loadList);

$("fq_livein").onchange=loadList;

loadList();
</script>
</body>
</html>
